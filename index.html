<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>å£²ä¸Šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .input-field {
            transition: all 0.3s ease;
        }
        .input-field:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        .ranking-item {
            transition: all 0.3s ease;
        }
        .ranking-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .edit-row {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        .modified-text {
            color: #dc2626;
            font-weight: 600;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .modal {
            backdrop-filter: blur(10px);
        }
        .password-modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.5);
        }
        .locked-tab {
            position: relative;
            overflow: hidden;
        }
        .locked-tab::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            font-size: 12px;
        }
        .comparison-indicator {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .comparison-up {
            background: #dcfce7;
            color: #166534;
        }
        .comparison-down {
            background: #fee2e2;
            color: #991b1b;
        }
        .comparison-neutral {
            background: #f3f4f6;
            color: #374151;
        }
        
        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³æœ€é©åŒ– */
        @media (max-width: 768px) {
            /* ã‚¿ãƒƒãƒæ“ä½œã®æœ€é©åŒ– */
            * {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºã®æ‹¡å¤§ */
            .tab-button {
                min-height: 44px;
                font-size: 14px;
                padding: 12px 16px;
            }
            
            /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ€é©åŒ– */
            .input-field {
                font-size: 16px; /* iOSã§ã‚ºãƒ¼ãƒ ã‚’é˜²ã */
                min-height: 44px;
                padding: 12px 16px;
            }
            
            /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®æœ€é©åŒ– */
            select, input, button {
                font-size: 16px;
                min-height: 44px;
            }
            
            /* ã‚«ãƒ¼ãƒ‰ã®ä½™ç™½èª¿æ•´ */
            .card {
                margin: 8px;
                padding: 16px;
            }
            
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®èª¿æ•´ */
            header h1 {
                font-size: 20px;
            }
            
            /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®èª¿æ•´ */
            nav .flex {
                gap: 4px;
            }
            
            /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èª¿æ•´ */
            .modal {
                padding: 16px;
            }
            
            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®èª¿æ•´ */
            .overflow-x-auto {
                font-size: 12px;
            }
            
            /* ã‚°ãƒ©ãƒ•ã®èª¿æ•´ */
            canvas {
                max-height: 300px;
            }
        }
        
        /* è¶…å°å‹ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ */
        @media (max-width: 480px) {
            .tab-button {
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .card {
                margin: 4px;
                padding: 12px;
            }
            
            header h1 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-400 via-pink-500 to-red-500">
    <div class="min-h-screen">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="bg-white/20 backdrop-blur-md border-b border-white/30">
            <div class="container mx-auto px-4 py-4">
                <h1 class="text-2xl font-bold text-white text-center">
                    ğŸ“Š å£²ä¸Šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
                </h1>
            </div>
        </header>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="bg-white/10 backdrop-blur-md border-b border-white/20">
            <div class="container mx-auto px-4">
                <div class="flex flex-wrap justify-center space-x-1 md:space-x-4 py-2">
                    <button class="tab-button active px-3 py-2 rounded-lg text-sm font-medium text-white/80 hover:text-white transition-all" data-tab="input">
                        ğŸ“ å£²ä¸Šå…¥åŠ›
                    </button>
                    <button class="tab-button px-3 py-2 rounded-lg text-sm font-medium text-white/80 hover:text-white transition-all" data-tab="analysis">
                        ğŸ“ˆ åº—èˆ—åˆ†æ
                    </button>
                    <button class="tab-button px-3 py-2 rounded-lg text-sm font-medium text-white/80 hover:text-white transition-all" data-tab="ranking">
                        ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                    </button>
                    <button class="tab-button px-3 py-2 rounded-lg text-sm font-medium text-white/80 hover:text-white transition-all" data-tab="history">
                        ğŸ“‹ å±¥æ­´ç®¡ç†
                    </button>
                    <button class="tab-button locked-tab px-3 py-2 rounded-lg text-sm font-medium text-white/80 hover:text-white transition-all" data-tab="headquarters">
                        ğŸ¢ æœ¬éƒ¨ç®¡ç†
                    </button>
                </div>
            </div>
        </nav>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="container mx-auto px-4 py-6">
            
            <!-- 1. å£²ä¸Šå…¥åŠ›ç”»é¢ -->
            <div id="input" class="tab-content active">
                <div class="card p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                        ğŸ“ å£²ä¸Šæ—¥å ±å…¥åŠ›
                    </h2>
                    
                    <form id="salesForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- æ—¥ä»˜é¸æŠ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… æ—¥ä»˜</label>
                                <input type="text" id="date" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="æ—¥ä»˜ã‚’é¸æŠ" readonly required>
                            </div>
                            
                            <!-- åº—èˆ—é¸æŠ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸª åº—èˆ—</label>
                                <select id="store_id" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                    <option value="">åº—èˆ—ã‚’é¸æŠ</option>
                                    <option value="store_001">æœ¬åº—</option>
                                    <option value="store_002">æ”¯åº—A</option>
                                    <option value="store_003">æ”¯åº—B</option>
                                    <option value="store_004">æ”¯åº—C</option>
                                </select>
                            </div>
                            
                            <!-- ã‚¹ã‚¿ãƒƒãƒ•å -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</label>
                                <input type="text" id="staff_name" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›" required>
                            </div>
                            
                            <!-- ç¾é‡‘å£²ä¸Š -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’° ç¾é‡‘å£²ä¸Š</label>
                                <input type="number" id="cash_sales" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0" min="0" step="1">
                            </div>
                            
                            <!-- ã‚«ãƒ¼ãƒ‰å£²ä¸Š -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’³ ã‚«ãƒ¼ãƒ‰å£²ä¸Š</label>
                                <input type="number" id="card_sales" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0" min="0" step="1">
                            </div>
                            
                            <!-- çµŒè²» -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ§¾ çµŒè²»</label>
                                <input type="number" id="expense" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0" min="0" step="1">
                            </div>
                            
                            <!-- é…’é¡é…é€é¡ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸº é…’é¡é…é€é¡</label>
                                <input type="number" id="liquor_delivery" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0" min="0" step="1">
                            </div>

                            <!-- æ—¥æ‰•ã„ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’¸ æ—¥æ‰•ã„ï¼ˆãã®ä»–ï¼‰</label>
                                <input type="number" id="daily_payment" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="0" min="0" step="1">
                            </div>
                        </div>

                        <!-- ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                            <textarea id="comment" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" rows="3" placeholder="å‚™è€ƒã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                        </div>
                        
                        <!-- è‡ªå‹•è¨ˆç®—çµæœ -->
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border border-purple-200 mt-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="text-center">
                                    <div class="text-sm text-gray-600 mb-1">ğŸ“Š åˆè¨ˆå£²ä¸Š</div>
                                    <div id="totalSalesDisplay" class="text-2xl font-bold text-purple-600">Â¥0</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-gray-600 mb-1">ğŸ’¼ å°ç­’æ®‹é‡‘</div>
                                    <div id="envelopeBalanceDisplay" class="text-2xl font-bold text-green-600">Â¥0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç™»éŒ²ãƒœã‚¿ãƒ³ -->
                        <div class="text-center mt-6">
                            <button type="submit" class="btn-primary px-8 py-3 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
                                ğŸ’¾ æ—¥å ±ã‚’ç™»éŒ²ã™ã‚‹
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 2. åº—èˆ—åˆ†æç”»é¢ -->
            <div id="analysis" class="tab-content">
                <div class="card p-6 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                        ğŸ“ˆ åº—èˆ—åˆ†æ
                    </h2>
                    
                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸª åº—èˆ—é¸æŠ</label>
                            <select id="analysisStore" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">å…¨åº—èˆ—</option>
                                <option value="store_001">æœ¬åº—</option>
                                <option value="store_002">æ”¯åº—A</option>
                                <option value="store_003">æ”¯åº—B</option>
                                <option value="store_004">æ”¯åº—C</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ</label>
                            <select id="analysisStaff" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">å…¨ã‚¹ã‚¿ãƒƒãƒ•</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… é–‹å§‹æ—¥</label>
                            <input type="text" id="analysisFromDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="é–‹å§‹æ—¥" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… çµ‚äº†æ—¥</label>
                            <input type="text" id="analysisToDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="çµ‚äº†æ—¥" readonly>
                        </div>
                    </div>
                    
                    <!-- æ•°å­—ãƒ»æ–‡å­—ã®ã¿ã®ãƒªãƒƒãƒãªè¡¨ç¤º -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- å£²ä¸Šã‚µãƒãƒªãƒ¼ -->
                        <div class="bg-white p-6 rounded-lg shadow-inner">
                            <h3 class="text-lg font-semibold text-gray-800 mb-6 text-center">ğŸ’° å£²ä¸Šã‚µãƒãƒªãƒ¼</h3>
                            <div id="salesSummaryDisplay" class="space-y-4">
                                <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200">
                                    <span class="text-gray-700 font-medium">ğŸ“ˆ ç·å£²ä¸Š</span>
                                    <span class="text-2xl font-bold text-green-600">Â¥0</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <span class="text-gray-700 font-medium">ğŸ“Š å¹³å‡æ—¥å£²ä¸Š</span>
                                    <span class="text-xl font-bold text-blue-600">Â¥0</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-purple-50 rounded-lg border border-purple-200">
                                    <span class="text-gray-700 font-medium">ğŸ“ ç·ãƒ¬ãƒãƒ¼ãƒˆæ•°</span>
                                    <span class="text-xl font-bold text-purple-600">0ä»¶</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-orange-50 rounded-lg border border-orange-200">
                                    <span class="text-gray-700 font-medium">ğŸ“… åˆ†ææœŸé–“</span>
                                    <span class="text-lg font-bold text-orange-600">0æ—¥é–“</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é€²æ—ï¼‹ç›®æ¨™é”æˆçŠ¶æ³ -->
                        <div class="bg-white p-6 rounded-lg shadow-inner">
                            <h3 class="text-lg font-semibold text-gray-800 mb-6 text-center">ğŸ¯ é€²æ—ï¼‹ç›®æ¨™é”æˆçŠ¶æ³</h3>
                            <div id="progressDisplay" class="space-y-4">
                                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-gray-700 font-medium">ğŸ¯ æœˆé–“ç›®æ¨™</span>
                                        <span class="text-lg font-bold text-yellow-600">Â¥0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-700 font-medium">ğŸ“Š é”æˆç‡</span>
                                        <span class="text-2xl font-bold text-yellow-600">0%</span>
                                    </div>
                                </div>
                                <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-gray-700 font-medium">ğŸ”º ç›®æ¨™ã¨ã®å·®é¡</span>
                                        <span class="text-lg font-bold text-red-600">Â¥0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-700 font-medium">ğŸ“ˆ å¿…è¦æ—¥å£²ä¸Š</span>
                                        <span class="text-lg font-bold text-red-600">Â¥0</span>
                                    </div>
                                </div>
                                <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-700 font-medium">â° æ®‹ã‚Šæ—¥æ•°</span>
                                        <span class="text-xl font-bold text-indigo-600">0æ—¥</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. åº—èˆ—ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ -->
            <div id="ranking" class="tab-content">
                <div class="card p-6 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                        ğŸ† åº—èˆ—ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                    </h2>
                    
                    <!-- æœŸé–“é¸æŠ -->
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-lg border border-yellow-200 mb-6">
                        <h3 class="text-lg font-semibold text-orange-800 mb-4">ğŸ“… æœŸé–“é¸æŠ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-orange-700 mb-2">é–‹å§‹æ—¥</label>
                                <input type="text" id="rankingFromDate" class="w-full px-4 py-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white" placeholder="é–‹å§‹æ—¥" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-orange-700 mb-2">çµ‚äº†æ—¥</label>
                                <input type="text" id="rankingToDate" class="w-full px-4 py-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-white" placeholder="çµ‚äº†æ—¥" readonly>
                            </div>
                            <div class="flex items-end">
                                <button id="rankingUpdateBtn" class="w-full bg-gradient-to-r from-orange-600 to-yellow-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-orange-700 hover:to-yellow-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                    ğŸ”„ æ›´æ–°
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="rankingList" class="space-y-3">
                        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>

            <!-- 4. å±¥æ­´ç®¡ç†ç”»é¢ -->
            <div id="history" class="tab-content">
                <div class="card p-6 max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                        ğŸ“‹ å±¥æ­´ç®¡ç†
                    </h2>
                    
                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸª åº—èˆ—é¸æŠ</label>
                            <select id="historyStore" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">å…¨åº—èˆ—</option>
                                <option value="store_001">æœ¬åº—</option>
                                <option value="store_002">æ”¯åº—A</option>
                                <option value="store_003">æ”¯åº—B</option>
                                <option value="store_004">æ”¯åº—C</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… é–‹å§‹æ—¥</label>
                            <input type="text" id="historyFromDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="é–‹å§‹æ—¥" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… çµ‚äº†æ—¥</label>
                            <input type="text" id="historyToDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="çµ‚äº†æ—¥" readonly>
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center">
                                <input type="checkbox" id="modifiedOnly" class="mr-2 text-purple-600 focus:ring-purple-500 rounded">
                                <span class="text-sm text-gray-700">ä¿®æ­£ã®ã¿è¡¨ç¤º</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 font-medium text-gray-900">æ—¥ä»˜</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">åº—èˆ—</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">ç¾é‡‘å£²ä¸Š</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">ã‚«ãƒ¼ãƒ‰å£²ä¸Š</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">çµŒè²»</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">åˆè¨ˆå£²ä¸Š</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">å°ç­’æ®‹é‡‘</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">ç·¨é›†è€…</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. æœ¬éƒ¨ç®¡ç†ç”»é¢ -->
            <div id="headquarters" class="tab-content">
                <div class="card p-6 max-w-7xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                        ğŸ¢ æœ¬éƒ¨ç®¡ç†ç”»é¢
                    </h2>
                    
                    <!-- æœŸé–“ãƒ»åº—èˆ—é¸æŠ -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg shadow-sm border border-purple-200 mb-6">
                        <h3 class="text-lg font-semibold text-purple-800 mb-4">ğŸ“… æœŸé–“ãƒ»åº—èˆ—é¸æŠ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-purple-700 mb-2">åº—èˆ—é¸æŠ</label>
                                <select id="hqStoreSelect" class="w-full px-4 py-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white">
                                    <option value="">å…¨åº—èˆ—</option>
                                    <option value="store_001">æœ¬åº—</option>
                                    <option value="store_002">æ”¯åº—A</option>
                                    <option value="store_003">æ”¯åº—B</option>
                                    <option value="store_004">æ”¯åº—C</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-purple-700 mb-2">é–‹å§‹æ—¥</label>
                                <input type="text" id="hqFromDate" class="w-full px-4 py-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white" placeholder="é–‹å§‹æ—¥" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-purple-700 mb-2">çµ‚äº†æ—¥</label>
                                <input type="text" id="hqToDate" class="w-full px-4 py-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white" placeholder="çµ‚äº†æ—¥" readonly>
                            </div>
                            <div class="flex items-end">
                                <button id="hqUpdateBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                                    <span id="updateBtnText">ğŸ”„ æ›´æ–°</span>
                                    <span id="updateBtnLoading" class="hidden">â³ æ›´æ–°ä¸­...</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border border-blue-200 transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ“Š ç·å£²ä¸Š</h3>
                                    <p class="text-3xl font-bold text-blue-600" id="totalSalesAmount">Â¥0</p>
                                    <p class="text-sm text-blue-500 mt-1">å…¨åº—èˆ—åˆè¨ˆ</p>
                                </div>
                                <div class="text-4xl text-blue-300">ğŸ’°</div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border border-green-200 transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-green-800 mb-2">ğŸ“ˆ æ—¥å¹³å‡</h3>
                                    <p class="text-3xl font-bold text-green-600" id="avgDailySales">Â¥0</p>
                                    <p class="text-sm text-green-500 mt-1">æ—¥å¹³å‡å£²ä¸Š</p>
                                </div>
                                <div class="text-4xl text-green-300">ğŸ“ˆ</div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg border border-purple-200 transform transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-purple-800 mb-2">ğŸ¢ åº—èˆ—æ•°</h3>
                                    <p class="text-3xl font-bold text-purple-600" id="activeStoreCount">4</p>
                                    <p class="text-sm text-purple-500 mt-1">ç¨¼åƒåº—èˆ—æ•°</p>
                                </div>
                                <div class="text-4xl text-purple-300">ğŸ¢</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- åº—èˆ—åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ† åº—èˆ—åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                            <div class="space-y-3" id="storePerformanceList">
                                <!-- åº—èˆ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                            </div>
                        </div>
                        
                        <!-- æœˆåˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰ -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“ˆ æœˆåˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆå‰æœˆå¯¾æ¯”ï¼‰</h3>
                            <div class="h-64">
                                <canvas id="monthlyTrendChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 font-medium text-gray-900">æ—¥ä»˜</th>
                                        <th class="px-4 py-3 font-medium text-gray-900">åº—èˆ—</th>
                                        <th class="px-4 py-3 font-medium text-gray-900">å£²ä¸Š</th>
                                        <th class="px-4 py-3 font-medium text-gray-900">çµŒè²»</th>
                                        <th class="px-4 py-3 font-medium text-gray-900">åˆ©ç›Š</th>
                                        <th class="px-4 py-3 font-medium text-gray-900">é”æˆç‡</th>
                                    </tr>
                                </thead>
                                <tbody id="hqDetailTableBody">
                                    <!-- è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- åº—èˆ—ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ¢ åº—èˆ—ç®¡ç†</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- åº—èˆ—ä¸€è¦§ -->
                            <div>
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-semibold text-gray-700">åº—èˆ—ä¸€è¦§</h4>
                                    <button id="addStoreBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
                                        + æ–°è¦åº—èˆ—
                                    </button>
                                </div>
                                <div class="space-y-2" id="storeManagementList">
                                    <!-- åº—èˆ—ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                            
                            <!-- äºˆç®—è¨­å®š -->
                            <div>
                                <h4 class="font-semibold text-gray-700 mb-4">äºˆç®—è¨­å®š</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">åº—èˆ—é¸æŠ</label>
                                        <select id="budgetStoreSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                            <option value="">åº—èˆ—ã‚’é¸æŠ</option>
                                            <option value="store_001">æœ¬åº—</option>
                                            <option value="store_002">æ”¯åº—A</option>
                                            <option value="store_003">æ”¯åº—B</option>
                                            <option value="store_004">æ”¯åº—C</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">æœˆé–“äºˆç®—</label>
                                        <input type="number" id="budgetAmount" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="äºˆç®—é‡‘é¡" min="0" step="1000">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… å¯¾è±¡æœˆ</label>
                                        <input type="text" id="budgetMonth" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="å¯¾è±¡æœˆã‚’é¸æŠ" readonly>
                                    </div>
                                    <button id="saveBudgetBtn" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                                        ğŸ’¾ äºˆç®—ä¿å­˜
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç´”åˆ©ç›Šè¨ˆç®—ã‚·ãƒ¼ãƒˆ -->
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-lg border border-indigo-200 mt-6">
                        <h3 class="text-xl font-bold text-indigo-800 mb-6 text-center">ğŸ’° ç´”åˆ©ç›Šè¨ˆç®—ã‚·ãƒ¼ãƒˆ</h3>
                        
                        <!-- æœŸé–“é¸æŠ -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6">
                            <h4 class="font-semibold text-gray-800 mb-4">ğŸ“… è¨ˆç®—æœŸé–“ãƒ»åº—èˆ—é¸æŠ</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label for="profitFromDate" class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ—¥</label>
                                    <input type="text" id="profitFromDate" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="é–‹å§‹æ—¥ã‚’é¸æŠ" readonly>
                                </div>
                                <div>
                                    <label for="profitToDate" class="block text-sm font-medium text-gray-700 mb-2">çµ‚äº†æ—¥</label>
                                    <input type="text" id="profitToDate" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="çµ‚äº†æ—¥ã‚’é¸æŠ" readonly>
                                </div>
                                <div>
                                    <label for="profitStoreSelect" class="block text-sm font-medium text-gray-700 mb-2">åº—èˆ—é¸æŠ</label>
                                    <select id="profitStoreSelect" class="w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">å…¨åº—èˆ—</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="calculateProfitBtn" class="w-full p-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                                        ğŸ“Š è¨ˆç®—å®Ÿè¡Œ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- è‡ªå‹•å…¥åŠ›åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6">
                            <h4 class="font-semibold text-gray-800 mb-4">ğŸ“‹ åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">åˆè¨ˆå£²ä¸Šé«˜ <span class="text-xs text-gray-500">(ç·¨é›†å¯)</span></label>
                                    <input type="number" id="autoTotalSales" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥å ±çµŒè²»åˆè¨ˆ <span class="text-xs text-gray-500">(ç·¨é›†å¯)</span></label>
                                    <input type="number" id="autoExpenses" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">é…’é¡é…é€é¡</label>
                                    <input type="number" id="autoLiquorDelivery" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- æ‰‹å‹•å…¥åŠ›é …ç›® -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6">
                            <h4 class="font-semibold text-gray-800 mb-4">âœï¸ æ‰‹å‹•å…¥åŠ›é …ç›®</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ  å®¶è³ƒ</label>
                                    <input type="number" id="rent" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“¡ é€šä¿¡è²» (Wi-Fi)</label>
                                    <input type="number" id="wifi" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ›¡ï¸ ä¿é™ºæ–™</label>
                                    <input type="number" id="insurance" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¤ æ¥­å‹™å§”è¨—è²»</label>
                                    <input type="number" id="outsourcing" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸµ ãƒªãƒ¼ã‚¹ (ç¬¬ä¸€èˆˆå•† ç­‰)</label>
                                    <input type="number" id="lease" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ§» ãŠã—ã¼ã‚Š</label>
                                    <input type="number" id="towels" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">âš¡ é›»æ°—</label>
                                    <input type="number" id="electricity" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’§ æ°´é“</label>
                                    <input type="number" id="water" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”¥ ã‚¬ã‚¹</label>
                                    <input type="number" id="gas" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- çµŒè²»é …ç›®è¿½åŠ  -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6">
                            <h4 class="font-semibold text-gray-800 mb-4">â• è¿½åŠ é …ç›®ï¼ˆåå…¥ãƒ»æ”¯å‡ºï¼‰</h4>
                            
                            <!-- å‹•çš„çµŒè²»é …ç›® -->
                            <div id="dynamicExpensesList" class="space-y-3 mb-4">
                                <!-- å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹çµŒè²»é …ç›®ãŒã“ã“ã«è¡¨ç¤º -->
                            </div>
                            
                            <!-- çµŒè²»é …ç›®è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h5 class="font-medium text-gray-700 mb-3">æ–°è¦é …ç›®è¿½åŠ </h5>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">é …ç›®å</label>
                                        <input type="text" id="newExpenseName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="é …ç›®åã‚’å…¥åŠ›">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">ç¨®åˆ¥</label>
                                        <select id="newExpenseType" class="w-full p-3 border border-gray-300 rounded-lg">
                                            <option value="expense">â– æ”¯å‡º</option>
                                            <option value="income">â• åå…¥</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">é‡‘é¡</label>
                                        <input type="number" id="newExpenseAmount" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                                    </div>
                                    <div class="flex items-end">
                                        <button id="addExpenseBtn" class="w-full p-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                                            â• è¿½åŠ 
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è¨ˆç®—çµæœ -->
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-lg border border-green-200">
                            <h4 class="font-semibold text-green-800 mb-4 text-center">ğŸ’¹ è¨ˆç®—çµæœ</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="text-center">
                                    <p class="text-sm text-green-700 mb-2">ç·åå…¥</p>
                                    <p id="totalRevenue" class="text-3xl font-bold text-green-600">Â¥0</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm text-green-700 mb-2">ç·æ”¯å‡º</p>
                                    <p id="totalExpenses" class="text-3xl font-bold text-red-600">Â¥0</p>
                                </div>
                                <div class="text-center md:col-span-2">
                                    <p class="text-lg text-green-700 mb-2">ç´”åˆ©ç›Š</p>
                                    <p id="netProfit" class="text-4xl font-bold text-green-800">Â¥0</p>
                                </div>
                            </div>
                            <div class="text-center mt-6">
                                <button id="exportProfitBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700">
                                    ğŸ“„ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200 mt-6">
                        <h4 class="font-semibold text-red-800 mb-4">ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</h4>
                        <p class="text-sm text-red-600 mb-4">â€» UIã¯ä¿æŒã—ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™</p>
                        <button id="clearTestDataBtn" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="passwordModal" class="fixed inset-0 password-modal hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 text-center">ğŸ”’ æœ¬éƒ¨ç®¡ç†èªè¨¼</h3>
                <p class="text-sm text-gray-600 mb-4 text-center">æœ¬éƒ¨ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="adminPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                    </div>
                    <div id="passwordError" class="text-red-600 text-sm hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚</div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancelPasswordBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button id="submitPasswordBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="fixed inset-0 bg-black/50 modal hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“ ãƒ‡ãƒ¼ã‚¿ç·¨é›†</h3>
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’° ç¾é‡‘å£²ä¸Š</label>
                            <input type="number" id="editCashSales" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="0" step="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’³ ã‚«ãƒ¼ãƒ‰å£²ä¸Š</label>
                            <input type="number" id="editCardSales" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="0" step="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ§¾ çµŒè²»</label>
                            <input type="number" id="editExpense" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="0" step="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸº é…’é¡é…é€é¡</label>
                            <input type="number" id="editLiquorDelivery" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" min="0" step="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">âœï¸ ç·¨é›†è€…å</label>
                            <input type="text" id="editEditorName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="ç·¨é›†è€…åã‚’å…¥åŠ›" required>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                            ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- åº—èˆ—ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="storeEditModal" class="fixed inset-0 bg-black/50 modal hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" id="storeEditModalTitle">åº—èˆ—ç·¨é›†</h3>
                <form id="storeEditForm">
                    <input type="hidden" id="editStoreId">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åº—èˆ—ID</label>
                            <input type="text" id="editStoreIdInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="store_001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åº—èˆ—å</label>
                            <input type="text" id="editStoreName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="åº—èˆ—åã‚’å…¥åŠ›">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancelStoreEditBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                            ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmationModal" class="fixed inset-0 bg-black/50 modal hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 text-center">ğŸ“‹ ç™»éŒ²å†…å®¹ã®ç¢ºèª</h3>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-2">ç™»éŒ²å†…å®¹</h4>
                        <div class="space-y-2 text-sm">
                            <div>æ—¥ä»˜: <span id="confirmDate" class="font-medium"></span></div>
                            <div>åº—èˆ—: <span id="confirmStore" class="font-medium"></span></div>
                            <div>æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•: <span id="confirmStaff" class="font-medium"></span></div>
                            <div>ç¾é‡‘å£²ä¸Š: <span id="confirmCash" class="font-medium"></span></div>
                            <div>ã‚«ãƒ¼ãƒ‰å£²ä¸Š: <span id="confirmCard" class="font-medium"></span></div>
                            <div>çµŒè²»: <span id="confirmExpense" class="font-medium"></span></div>
                            <div>é…’é¡é…é€é¡: <span id="confirmLiquor" class="font-medium"></span></div>
                            <div class="border-t pt-2 mt-2">
                                <div>åˆè¨ˆå£²ä¸Š: <span id="confirmTotal" class="font-medium text-blue-600"></span></div>
                                <div>å°ç­’æ®‹é‡‘: <span id="confirmBalance" class="font-medium text-green-600"></span></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="checkDate" class="w-4 h-4 text-purple-600 border-gray-300 rounded">
                            <label for="checkDate" class="text-sm text-gray-700">æ—¥ä»˜ã‚’ç¢ºèªã—ã¾ã—ãŸ</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="checkStore" class="w-4 h-4 text-purple-600 border-gray-300 rounded">
                            <label for="checkStore" class="text-sm text-gray-700">åº—èˆ—ã‚’ç¢ºèªã—ã¾ã—ãŸ</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="checkSales" class="w-4 h-4 text-purple-600 border-gray-300 rounded">
                            <label for="checkSales" class="text-sm text-gray-700">å£²ä¸Šé‡‘é¡ã‚’ç¢ºèªã—ã¾ã—ãŸ</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="checkExpense" class="w-4 h-4 text-purple-600 border-gray-300 rounded">
                            <label for="checkExpense" class="text-sm text-gray-700">çµŒè²»ã‚’ç¢ºèªã—ã¾ã—ãŸ</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="checkTotal" class="w-4 h-4 text-purple-600 border-gray-300 rounded">
                            <label for="checkTotal" class="text-sm text-gray-700">åˆè¨ˆé‡‘é¡ã‚’ç¢ºèªã—ã¾ã—ãŸ</label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelConfirmBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="button" id="finalSubmitBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors opacity-50 cursor-not-allowed" disabled>
                        ç™»éŒ²å®Œäº†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let salesData = [];
        let editHistory = [];
        let currentChart = null;
        let comparisonChart = null;
        let monthlyTrendChart = null;
        let isHQAuthenticated = false;
        let storeData = {};
        let budgetData = {};

        // åº—èˆ—ãƒã‚¹ã‚¿ï¼ˆåˆæœŸåŒ–æ™‚ã«å‹•çš„ã«è¨­å®šï¼‰
        let stores = {};

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCPAFs5hVHNgG9X5z9enzspidT1ZwJJ9-A",
            authDomain: "uriagehoukoku-7f691.firebaseapp.com",
            databaseURL: "https://uriagehoukoku-7f691-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "uriagehoukoku-7f691",
            storageBucket: "uriagehoukoku-7f691.firebasestorage.app",
            messagingSenderId: "343060704167",
            appId: "1:343060704167:web:e0b3379a318c09dab02482",
            measurementId: "G-H63PH8NRBJ"
        };

        // FirebaseåˆæœŸåŒ–
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeFlatpickr();
            initializeCalculation();
            initializeTabSwitching();
            initializeFormSubmission();
            initializeHistoryFilters();
            initializeHQAuth();
            initializeStoreManagement();
            initializeConfirmationModal();
            loadData();
            updateAllViews();
            
            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('clearTestDataBtn').addEventListener('click', function() {
                if (confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                    clearTestData();
                }
            });

            // ç´”åˆ©ç›Šè¨ˆç®—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('calculateProfitBtn').addEventListener('click', function() {
                calculateProfit();
            });

            // ç´”åˆ©ç›ŠCSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('exportProfitBtn').addEventListener('click', function() {
                exportProfitCSV();
            });

            // çµŒè²»é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('addExpenseBtn').addEventListener('click', function() {
                addDynamicExpense();
            });
            
            // çµ±è¨ˆæƒ…å ±ã‚’åˆæœŸåŒ–
            setTimeout(() => {
                updateHQStatistics();
            }, 200);
        });

        // FlatpickråˆæœŸåŒ–
        function initializeFlatpickr() {
            // å£²ä¸Šå…¥åŠ›ã®æ—¥ä»˜
            flatpickr("#date", {
                locale: "ja",
                dateFormat: "Y-m-d",
                defaultDate: new Date(),
                allowInput: false
            });

            // åˆ†æç”»é¢ã®æ—¥ä»˜ç¯„å›²
            flatpickr("#analysisFromDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false,
                onChange: function() {
                    updateAnalysisChart();
                }
            });

            flatpickr("#analysisToDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false,
                onChange: function() {
                    updateAnalysisChart();
                }
            });

            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã®æ—¥ä»˜ç¯„å›²
            flatpickr("#rankingFromDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false,
                defaultDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1), // å½“æœˆ1æ—¥
                onChange: function() {
                    updateRanking();
                }
            });

            flatpickr("#rankingToDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false,
                defaultDate: new Date(), // ä»Šæ—¥
                onChange: function() {
                    updateRanking();
                }
            });

            // å±¥æ­´ç”»é¢ã®æ—¥ä»˜ç¯„å›²
            flatpickr("#historyFromDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false,
                onChange: function() {
                    updateHistoryTable();
                }
            });

            flatpickr("#historyToDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false,
                onChange: function() {
                    updateHistoryTable();
                }
            });

            // æœ¬éƒ¨ç®¡ç†ç”»é¢ã®æ—¥ä»˜ç¯„å›²
            flatpickr("#hqFromDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false,
                onChange: function() {
                    updateHQDashboard();
                }
            });

            flatpickr("#hqToDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false,
                onChange: function() {
                    updateHQDashboard();
                }
            });

            // ç´”åˆ©ç›Šè¨ˆç®—ã®æ—¥ä»˜
            flatpickr("#profitFromDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false
            });

            flatpickr("#profitToDate", {
                locale: "ja",
                dateFormat: "Y-m-d",
                allowInput: false
            });

            // äºˆç®—å¯¾è±¡æœˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœˆé¸æŠï¼‰
            flatpickr("#budgetMonth", {
                locale: "ja",
                dateFormat: "Y-m",
                allowInput: false,
                defaultDate: new Date(),
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        const date = selectedDates[0];
                        const yearMonth = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                        instance.input.value = yearMonth;
                    }
                }
            });
        }

        // è‡ªå‹•è¨ˆç®—ã®åˆæœŸåŒ–
        function initializeCalculation() {
            ['cash_sales', 'card_sales', 'expense', 'daily_payment'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', calculateValues);
                }
            });
        }

        // è‡ªå‹•è¨ˆç®—ã®å®Ÿè¡Œ
        function calculateValues() {
            const cashSales = parseInt(document.getElementById('cash_sales').value) || 0;
            const cardSales = parseInt(document.getElementById('card_sales').value) || 0;
            const expense = parseInt(document.getElementById('expense').value) || 0;
            const dailyPayment = parseInt(document.getElementById('daily_payment').value) || 0;

            // æ—¥æ‰•ã„ã¯åˆè¨ˆå£²ä¸Šã«ã¯ãƒ—ãƒ©ã‚¹ã•ã‚Œãªã„
            const totalSales = cashSales + cardSales;
            
            // å°ç­’æ®‹é‡‘ã‹ã‚‰ã¯æ—¥æ‰•ã„ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹
            const envelopeBalance = cashSales - expense - dailyPayment;

            document.getElementById('totalSalesDisplay').textContent = `Â¥${formatNumber(totalSales)}`;
            document.getElementById('envelopeBalanceDisplay').textContent = `Â¥${formatNumber(envelopeBalance)}`;
            
            // å°ç­’æ®‹é‡‘ã®è‰²ã‚’å¤‰æ›´
            const balanceDisplay = document.getElementById('envelopeBalanceDisplay');
            if (envelopeBalance < 0) {
                balanceDisplay.className = 'text-2xl font-bold text-red-600';
            } else {
                balanceDisplay.className = 'text-2xl font-bold text-green-600';
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã®åˆæœŸåŒ–
        function initializeTabSwitching() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    this.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                    
                    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å‡¦ç†
                    if (targetTab === 'analysis') {
                        updateAnalysisChart();
                    } else if (targetTab === 'ranking') {
                        updateRanking();
                    } else if (targetTab === 'history') {
                        updateHistoryTable();
                    } else if (targetTab === 'headquarters') {
                        if (!isHQAuthenticated) {
                            showPasswordModal();
                            return;
                        }
                        updateHeadquartersView();
                    }
                });
            });
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã®åˆæœŸåŒ–
        function initializeFormSubmission() {
            const form = document.getElementById('salesForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                submitSalesData();
            });

            const editForm = document.getElementById('editForm');
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveEdit();
            });
        }

        // å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®åˆæœŸåŒ–
        function initializeHistoryFilters() {
            ['analysisStore', 'analysisStaff', 'historyStore', 'modifiedOnly', 'hqStoreSelect'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        if (id === 'analysisStore') {
                            updateStaffOptions();
                            updateAnalysisChart();
                        } else if (id === 'analysisStaff') {
                            updateAnalysisChart();
                        } else if (id === 'hqStoreSelect') {
                            updateHQDashboard();
                        } else {
                            updateHistoryTable();
                        }
                    });
                }
            });

            // æœ¬éƒ¨ç®¡ç†æ›´æ–°ãƒœã‚¿ãƒ³
            document.getElementById('hqUpdateBtn').addEventListener('click', function() {
                showUpdateLoading();
                updateHQDashboard();
                setTimeout(() => {
                    hideUpdateLoading();
                    showToast('ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'success');
                }, 800);
            });

            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°ãƒœã‚¿ãƒ³
            document.getElementById('rankingUpdateBtn').addEventListener('click', function() {
                updateRanking();
                showToast('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            });
        }

        // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡
        function submitSalesData() {
            const cashSales = parseInt(document.getElementById('cash_sales').value) || 0;
            const cardSales = parseInt(document.getElementById('card_sales').value) || 0;
            const expense = parseInt(document.getElementById('expense').value) || 0;
            const dailyPayment = parseInt(document.getElementById('daily_payment').value) || 0;

            const formData = {
                id: Date.now().toString(),
                date: document.getElementById('date').value,
                store_id: document.getElementById('store_id').value,
                staff_name: document.getElementById('staff_name').value.trim(),
                cash_sales: cashSales,
                card_sales: cardSales,
                expense: expense,
                liquor_delivery: parseInt(document.getElementById('liquor_delivery').value) || 0,
                daily_payment: dailyPayment,
                comment: document.getElementById('comment').value.trim(),
                total_sales: cashSales + cardSales,  // æ—¥æ‰•ã„ã¯åˆè¨ˆå£²ä¸Šã«å«ã¾ãªã„
                envelope_balance: cashSales - expense - dailyPayment,  // æ—¥æ‰•ã„ã¯å°ç­’æ®‹é‡‘ã‹ã‚‰å¼•ã
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!formData.date || !formData.store_id || !formData.staff_name) {
                showToast('æ—¥ä»˜ã€åº—èˆ—ã€ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const existingIndex = salesData.findIndex(item => 
                item.date === formData.date && item.store_id === formData.store_id
            );

            if (existingIndex !== -1) {
                showToast('ãã®æ—¥ã¯å¸¸ã«ç™»éŒ²æ¸ˆãªã®ã§ã§ãã¾ã›ã‚“', 'error');
                return;
            }

            // ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            showConfirmationModal(formData);
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
        function clearForm() {
            document.getElementById('staff_name').value = '';
            document.getElementById('cash_sales').value = '';
            document.getElementById('card_sales').value = '';
            document.getElementById('expense').value = '';
            document.getElementById('liquor_delivery').value = '';
            document.getElementById('daily_payment').value = '';
            document.getElementById('comment').value = '';
            calculateValues();
        }

        // åˆ†æãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆæ•°å­—è¡¨ç¤ºç”¨ï¼‰
        function updateAnalysisChart() {
            const storeId = document.getElementById('analysisStore').value;
            const staffName = document.getElementById('analysisStaff').value;
            const fromDate = document.getElementById('analysisFromDate').value;
            const toDate = document.getElementById('analysisToDate').value;

            let filteredData = salesData;

            if (storeId) {
                filteredData = filteredData.filter(item => item.store_id === storeId);
            }

            if (staffName) {
                filteredData = filteredData.filter(item => item.staff_name === staffName);
            }

            if (fromDate) {
                filteredData = filteredData.filter(item => item.date >= fromDate);
            }

            if (toDate) {
                filteredData = filteredData.filter(item => item.date <= toDate);
            }

            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            filteredData.sort((a, b) => new Date(a.date) - new Date(b.date));

            // å£²ä¸Šã‚µãƒãƒªãƒ¼ã®è¨ˆç®—
            const totalSales = filteredData.reduce((sum, item) => sum + item.total_sales, 0);
            const totalExpense = filteredData.reduce((sum, item) => sum + item.expense, 0);
            const reportCount = filteredData.length;
            const avgDailySales = reportCount > 0 ? totalSales / reportCount : 0;
            const analysisPeriod = reportCount > 0 ? reportCount : 0;

            // äºˆç®—ã¨é€²æ—ã®è¨ˆç®—
            const currentMonth = new Date().toISOString().slice(0, 7);
            const budgetKey = `${storeId}_${currentMonth}`;
            const monthlyBudget = budgetData[budgetKey]?.amount || 0;
            const achievementRate = monthlyBudget > 0 ? (totalSales / monthlyBudget * 100).toFixed(1) : 0;
            const targetDifference = monthlyBudget - totalSales;
            const remainingDays = Math.max(0, new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate() - new Date().getDate());
            const requiredDailySales = remainingDays > 0 ? targetDifference / remainingDays : 0;

            // å£²ä¸Šã‚µãƒãƒªãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
            const salesSummaryDisplay = document.getElementById('salesSummaryDisplay');
            if (salesSummaryDisplay) {
                salesSummaryDisplay.innerHTML = `
                    <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg border border-green-200">
                        <span class="text-gray-700 font-medium">ğŸ“ˆ ç·å£²ä¸Š</span>
                        <span class="text-2xl font-bold text-green-600">Â¥${formatNumber(totalSales)}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <span class="text-gray-700 font-medium">ğŸ“Š å¹³å‡æ—¥å£²ä¸Š</span>
                        <span class="text-xl font-bold text-blue-600">Â¥${formatNumber(avgDailySales)}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <span class="text-gray-700 font-medium">ğŸ“ ç·ãƒ¬ãƒãƒ¼ãƒˆæ•°</span>
                        <span class="text-xl font-bold text-purple-600">${reportCount}ä»¶</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <span class="text-gray-700 font-medium">ğŸ“… åˆ†ææœŸé–“</span>
                        <span class="text-lg font-bold text-orange-600">${analysisPeriod}æ—¥é–“</span>
                    </div>
                `;
            }

            // é€²æ—è¡¨ç¤ºã‚’æ›´æ–°
            const progressDisplay = document.getElementById('progressDisplay');
            if (progressDisplay) {
                progressDisplay.innerHTML = `
                    <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700 font-medium">ğŸ¯ æœˆé–“ç›®æ¨™</span>
                            <span class="text-lg font-bold text-yellow-600">Â¥${formatNumber(monthlyBudget)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-medium">ğŸ“Š é”æˆç‡</span>
                            <span class="text-2xl font-bold text-yellow-600">${achievementRate}%</span>
                        </div>
                    </div>
                    <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700 font-medium">ğŸ”º ç›®æ¨™ã¨ã®å·®é¡</span>
                            <span class="text-lg font-bold text-red-600">Â¥${formatNumber(Math.abs(targetDifference))}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-medium">ğŸ“ˆ å¿…è¦æ—¥å£²ä¸Š</span>
                            <span class="text-lg font-bold text-red-600">Â¥${formatNumber(Math.max(0, requiredDailySales))}</span>
                        </div>
                    </div>
                    <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 font-medium">â° æ®‹ã‚Šæ—¥æ•°</span>
                            <span class="text-xl font-bold text-indigo-600">${remainingDays}æ—¥</span>
                        </div>
                    </div>
                `;
            }

            // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠã‚’æ›´æ–°
            updateStaffOptions();
        }


        // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ›´æ–°
        function updateStaffOptions() {
            const storeId = document.getElementById('analysisStore').value;
            const staffSelect = document.getElementById('analysisStaff');
            
            // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿å­˜
            const currentValue = staffSelect.value;
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
            staffSelect.innerHTML = '<option value="">å…¨ã‚¹ã‚¿ãƒƒãƒ•</option>';
            
            // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚¹ã‚¿ãƒƒãƒ•åã‚’å–å¾—
            let filteredData = salesData;
            if (storeId) {
                filteredData = filteredData.filter(item => item.store_id === storeId);
            }
            
            const staffNames = [...new Set(filteredData.map(item => item.staff_name).filter(name => name))];
            staffNames.sort();
            
            staffNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                staffSelect.appendChild(option);
            });
            
            // ä»¥å‰ã®é¸æŠå€¤ã‚’å¾©å…ƒ
            if (currentValue && staffNames.includes(currentValue)) {
                staffSelect.value = currentValue;
            }
        }

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®æ›´æ–°
        function updateRanking() {
            const fromDate = document.getElementById('rankingFromDate').value;
            const toDate = document.getElementById('rankingToDate').value;

            let filteredData = salesData;

            if (fromDate) {
                filteredData = filteredData.filter(item => item.date >= fromDate);
            }

            if (toDate) {
                filteredData = filteredData.filter(item => item.date <= toDate);
            }

            const storeRanking = {};

            filteredData.forEach(item => {
                if (!storeRanking[item.store_id]) {
                    storeRanking[item.store_id] = {
                        totalSales: 0,
                        count: 0
                    };
                }
                storeRanking[item.store_id].totalSales += item.total_sales;
                storeRanking[item.store_id].count++;
            });

            const ranking = Object.entries(storeRanking)
                .map(([storeId, data]) => {
                    // äºˆç®—ã‚’å–å¾—ï¼ˆæœˆãƒ™ãƒ¼ã‚¹ï¼‰
                    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                    const budgetKey = `${storeId}_${currentMonth}`;
                    const budget = budgetData[budgetKey]?.amount || 0;
                    const achievement = budget > 0 ? Math.round((data.totalSales / budget) * 100) : 0;

                    return {
                        storeId,
                        storeName: stores[storeId] || storeData[storeId] || storeId,
                        totalSales: data.totalSales,
                        count: data.count,
                        budget: budget,
                        achievement: achievement
                    };
                })
                .sort((a, b) => b.totalSales - a.totalSales);

            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';

            if (ranking.length === 0) {
                rankingList.innerHTML = '<div class="text-center text-gray-500 py-8">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            ranking.forEach((item, index) => {
                const rank = index + 1;
                let rankIcon = '';
                let rankColor = '';

                if (rank === 1) {
                    rankIcon = 'ğŸ¥‡';
                    rankColor = 'bg-yellow-100 border-yellow-400';
                } else if (rank === 2) {
                    rankIcon = 'ğŸ¥ˆ';
                    rankColor = 'bg-gray-100 border-gray-400';
                } else if (rank === 3) {
                    rankIcon = 'ğŸ¥‰';
                    rankColor = 'bg-orange-100 border-orange-400';
                } else {
                    rankIcon = `${rank}ä½`;
                    rankColor = 'bg-white border-gray-200';
                }

                const rankingItem = document.createElement('div');
                rankingItem.className = `ranking-item p-4 rounded-lg border-2 ${rankColor} transition-all duration-300`;
                const achievementColor = item.achievement >= 100 ? 'text-green-600' : item.achievement >= 80 ? 'text-yellow-600' : 'text-red-600';
                const budgetText = item.budget > 0 ? `äºˆç®—: Â¥${formatNumber(item.budget)}` : 'äºˆç®—æœªè¨­å®š';
                const achievementText = item.budget > 0 ? `${item.achievement}%` : 'N/A';

                rankingItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="text-2xl font-bold">${rankIcon}</div>
                            <div>
                                <div class="text-lg font-semibold text-gray-800">${item.storeName}</div>
                                <div class="text-sm text-gray-600">${item.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿</div>
                                <div class="text-xs text-gray-500">${budgetText}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-purple-600">Â¥${formatNumber(item.totalSales)}</div>
                            <div class="text-sm text-gray-500">ç·å£²ä¸Š</div>
                            <div class="text-lg font-bold ${achievementColor}">é”æˆç‡: ${achievementText}</div>
                        </div>
                    </div>
                `;
                rankingList.appendChild(rankingItem);
            });
        }

        // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
        function updateHistoryTable() {
            const storeId = document.getElementById('historyStore').value;
            const fromDate = document.getElementById('historyFromDate').value;
            const toDate = document.getElementById('historyToDate').value;
            const modifiedOnly = document.getElementById('modifiedOnly').checked;

            let filteredData = salesData;

            if (storeId) {
                filteredData = filteredData.filter(item => item.store_id === storeId);
            }

            if (fromDate) {
                filteredData = filteredData.filter(item => item.date >= fromDate);
            }

            if (toDate) {
                filteredData = filteredData.filter(item => item.date <= toDate);
            }

            if (modifiedOnly) {
                filteredData = filteredData.filter(item => 
                    editHistory.some(edit => edit.originalId === item.id)
                );
            }

            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));

            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-8">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            filteredData.forEach(item => {
                const isModified = editHistory.some(edit => edit.originalId === item.id);
                const row = document.createElement('tr');
                row.className = isModified ? 'edit-row' : 'hover:bg-gray-50';
                
                // ç·¨é›†è€…æƒ…å ±ã‚’å–å¾—
                const editorInfo = getEditorInfo(item.id);
                
                row.innerHTML = `
                    <td class="px-4 py-3 border-b">${item.date}</td>
                    <td class="px-4 py-3 border-b">${stores[item.store_id] || storeData[item.store_id] || item.store_id}</td>
                    <td class="px-4 py-3 border-b ${isModified ? 'modified-text' : ''}">Â¥${formatNumber(item.cash_sales)}</td>
                    <td class="px-4 py-3 border-b ${isModified ? 'modified-text' : ''}">Â¥${formatNumber(item.card_sales)}</td>
                    <td class="px-4 py-3 border-b ${isModified ? 'modified-text' : ''}">Â¥${formatNumber(item.expense)}</td>
                    <td class="px-4 py-3 border-b ${isModified ? 'modified-text' : ''}">Â¥${formatNumber(item.total_sales)}</td>
                    <td class="px-4 py-3 border-b ${isModified ? 'modified-text' : ''}">Â¥${formatNumber(item.envelope_balance)}</td>
                    <td class="px-4 py-3 border-b">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                            editorInfo.editor ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-500'
                        }">
                            ${editorInfo.editor || 'æœªç·¨é›†'}
                        </span>
                        ${editorInfo.editDate ? `<div class="text-xs text-gray-500 mt-1">${editorInfo.editDate}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 border-b">
                        <button onclick="openEditModal('${item.id}')" class="text-blue-600 hover:text-blue-800 font-medium">
                            ç·¨é›†
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEditModal(id) {
            const item = salesData.find(data => data.id === id);
            if (!item) return;

            document.getElementById('editId').value = id;
            document.getElementById('editCashSales').value = item.cash_sales;
            document.getElementById('editCardSales').value = item.card_sales;
            document.getElementById('editExpense').value = item.expense;
            document.getElementById('editLiquorDelivery').value = item.liquor_delivery;
            document.getElementById('editEditorName').value = '';

            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // ç·¨é›†ã‚’ä¿å­˜
        function saveEdit() {
            const id = document.getElementById('editId').value;
            const item = salesData.find(data => data.id === id);
            if (!item) return;

            const editorName = document.getElementById('editEditorName').value.trim();
            if (!editorName) {
                showToast('ç·¨é›†è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const originalItem = { ...item };
            
            item.cash_sales = parseInt(document.getElementById('editCashSales').value) || 0;
            item.card_sales = parseInt(document.getElementById('editCardSales').value) || 0;
            item.expense = parseInt(document.getElementById('editExpense').value) || 0;
            item.liquor_delivery = parseInt(document.getElementById('editLiquorDelivery').value) || 0;
            item.total_sales = item.cash_sales + item.card_sales;
            item.envelope_balance = item.cash_sales - item.expense;
            item.updated_at = new Date().toISOString();

            // ç·¨é›†å±¥æ­´ã‚’è¨˜éŒ²
            editHistory.push({
                originalId: id,
                originalData: originalItem,
                newData: { ...item },
                editedAt: new Date().toISOString(),
                editor: editorName
            });

            saveData();
            closeEditModal();
            updateAllViews();
            showToast('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        }

        // å…¨ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
        function updateAllViews() {
            updateAnalysisChart();
            updateRanking();
            updateHistoryTable();
            updateHeadquartersView();
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveData() {
            localStorage.setItem('salesData', JSON.stringify(salesData));
            localStorage.setItem('editHistory', JSON.stringify(editHistory));
        }

        // å‹•çš„çµŒè²»é …ç›®ã®é…åˆ—
        let dynamicExpenses = [];

        // å‹•çš„é …ç›®è¿½åŠ æ©Ÿèƒ½
        function addDynamicExpense() {
            const name = document.getElementById('newExpenseName').value.trim();
            const type = document.getElementById('newExpenseType').value;
            const amount = parseInt(document.getElementById('newExpenseAmount').value) || 0;

            if (!name) {
                showToast('é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const expense = {
                id: Date.now().toString(),
                name: name,
                type: type,  // 'expense' ã¾ãŸã¯ 'income'
                amount: amount
            };

            dynamicExpenses.push(expense);
            updateDynamicExpensesList();

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            document.getElementById('newExpenseName').value = '';
            document.getElementById('newExpenseAmount').value = '';

            const typeText = type === 'income' ? 'åå…¥é …ç›®' : 'æ”¯å‡ºé …ç›®';
            showToast(`${typeText}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
        }

        // å‹•çš„é …ç›®ãƒªã‚¹ãƒˆã®æ›´æ–°
        function updateDynamicExpensesList() {
            const container = document.getElementById('dynamicExpensesList');
            container.innerHTML = '';

            dynamicExpenses.forEach(expense => {
                const div = document.createElement('div');
                const bgColor = expense.type === 'income' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                const textColor = expense.type === 'income' ? 'text-green-800' : 'text-red-800';
                const borderColor = expense.type === 'income' ? 'border-green-300' : 'border-red-300';
                const typeIcon = expense.type === 'income' ? 'â•' : 'â–';
                
                div.className = `flex items-center space-x-3 p-3 ${bgColor} rounded-lg border`;
                div.innerHTML = `
                    <div class="w-8 text-center">
                        <span class="text-lg">${typeIcon}</span>
                    </div>
                    <div class="flex-1">
                        <span class="font-medium ${textColor}">${expense.name}</span>
                    </div>
                    <div class="w-32">
                        <input type="number" value="${expense.amount}" 
                               onchange="updateDynamicExpenseAmount('${expense.id}', this.value)"
                               class="w-full p-2 border ${borderColor} rounded text-right">
                    </div>
                    <button onclick="removeDynamicExpense('${expense.id}')" 
                            class="text-red-600 hover:text-red-800 font-bold text-lg">
                        âœ•
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // å‹•çš„çµŒè²»é …ç›®ã®é‡‘é¡æ›´æ–°
        function updateDynamicExpenseAmount(id, amount) {
            const expense = dynamicExpenses.find(item => item.id === id);
            if (expense) {
                expense.amount = parseInt(amount) || 0;
            }
        }

        // å‹•çš„çµŒè²»é …ç›®ã®å‰Šé™¤
        function removeDynamicExpense(id) {
            dynamicExpenses = dynamicExpenses.filter(item => item.id !== id);
            updateDynamicExpensesList();
            showToast('çµŒè²»é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        }

        // ç´”åˆ©ç›Šè¨ˆç®—æ©Ÿèƒ½
        function calculateProfit() {
            const fromDate = document.getElementById('profitFromDate').value;
            const toDate = document.getElementById('profitToDate').value;
            const storeId = document.getElementById('profitStoreSelect').value;

            if (!fromDate || !toDate) {
                showToast('æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredData = salesData.filter(item => {
                return item.date >= fromDate && item.date <= toDate;
            });

            if (storeId) {
                filteredData = filteredData.filter(item => item.store_id === storeId);
            }

            // è‡ªå‹•è¨ˆç®—ãƒ‡ãƒ¼ã‚¿
            const totalSales = filteredData.reduce((sum, item) => sum + (item.total_sales || 0), 0);
            const totalExpenses = filteredData.reduce((sum, item) => sum + (item.expense || 0), 0);
            const totalLiquorDelivery = filteredData.reduce((sum, item) => sum + (item.liquor_delivery || 0), 0);

            // è‡ªå‹•å…¥åŠ›æ¬„ã«è¨­å®š
            document.getElementById('autoTotalSales').value = totalSales;
            document.getElementById('autoExpenses').value = totalExpenses;
            document.getElementById('autoLiquorDelivery').value = totalLiquorDelivery;

            // æ‰‹å‹•å…¥åŠ›é …ç›®
            const rent = parseInt(document.getElementById('rent').value) || 0;
            const wifi = parseInt(document.getElementById('wifi').value) || 0;
            const insurance = parseInt(document.getElementById('insurance').value) || 0;
            const outsourcing = parseInt(document.getElementById('outsourcing').value) || 0;
            const lease = parseInt(document.getElementById('lease').value) || 0;
            const towels = parseInt(document.getElementById('towels').value) || 0;
            const electricity = parseInt(document.getElementById('electricity').value) || 0;
            const water = parseInt(document.getElementById('water').value) || 0;
            const gas = parseInt(document.getElementById('gas').value) || 0;

            // å‹•çš„é …ç›®ã®åå…¥ãƒ»æ”¯å‡ºã‚’åˆ†é›¢è¨ˆç®—
            const dynamicIncome = dynamicExpenses
                .filter(item => item.type === 'income')
                .reduce((sum, item) => sum + item.amount, 0);
            const dynamicExpensesTotal = dynamicExpenses
                .filter(item => item.type === 'expense')
                .reduce((sum, item) => sum + item.amount, 0);

            // è¨ˆç®—
            const totalRevenue = totalSales + dynamicIncome;  // å£²ä¸Š + å‹•çš„åå…¥
            const totalCosts = totalExpenses + rent + wifi + insurance + outsourcing + lease + 
                             towels + electricity + water + gas + dynamicExpensesTotal;  // å›ºå®šæ”¯å‡º + å‹•çš„æ”¯å‡º
            const netProfit = totalRevenue - totalCosts;

            // çµæœè¡¨ç¤º
            document.getElementById('totalRevenue').textContent = `Â¥${formatNumber(totalRevenue)}`;
            document.getElementById('totalExpenses').textContent = `Â¥${formatNumber(totalCosts)}`;
            document.getElementById('netProfit').textContent = `Â¥${formatNumber(netProfit)}`;
            document.getElementById('netProfit').className = netProfit >= 0 ? 
                'text-4xl font-bold text-green-800' : 'text-4xl font-bold text-red-800';

            showToast('ç´”åˆ©ç›Šã‚’è¨ˆç®—ã—ã¾ã—ãŸ', 'success');
        }

        // ç´”åˆ©ç›Šè¨ˆç®—çµæœã‚’CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportProfitCSV() {
            const fromDate = document.getElementById('profitFromDate').value;
            const toDate = document.getElementById('profitToDate').value;
            const storeId = document.getElementById('profitStoreSelect').value;
            
            if (!fromDate || !toDate) {
                showToast('ã¾ãšè¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const totalRevenue = document.getElementById('totalRevenue').textContent.replace(/[Â¥,]/g, '');
            const totalExpenses = document.getElementById('totalExpenses').textContent.replace(/[Â¥,]/g, '');
            const netProfit = document.getElementById('netProfit').textContent.replace(/[Â¥,]/g, '');

            // è©³ç´°çµŒè²»ã®å–å¾—
            const autoTotalSales = document.getElementById('autoTotalSales').value;
            const autoExpenses = document.getElementById('autoExpenses').value;
            const rent = document.getElementById('rent').value || 0;
            const wifi = document.getElementById('wifi').value || 0;
            const insurance = document.getElementById('insurance').value || 0;
            const outsourcing = document.getElementById('outsourcing').value || 0;
            const lease = document.getElementById('lease').value || 0;
            const towels = document.getElementById('towels').value || 0;
            const electricity = document.getElementById('electricity').value || 0;
            const water = document.getElementById('water').value || 0;
            const gas = document.getElementById('gas').value || 0;
            let csvContent = [
                ['ç´”åˆ©ç›Šè¨ˆç®—ãƒ¬ãƒãƒ¼ãƒˆ'],
                ['è¨ˆç®—æœŸé–“', `${fromDate} ã€œ ${toDate}`],
                ['å¯¾è±¡åº—èˆ—', storeId ? (stores[storeId] || storeId) : 'å…¨åº—èˆ—'],
                [''],
                ['== åå…¥ =='],
                ['åˆè¨ˆå£²ä¸Šé«˜', autoTotalSales]
            ];

            // å‹•çš„åå…¥é …ç›®ã‚’è¿½åŠ 
            const dynamicIncomeItems = dynamicExpenses.filter(item => item.type === 'income');
            dynamicIncomeItems.forEach(item => {
                csvContent.push([item.name + ' (è¿½åŠ åå…¥)', item.amount]);
            });

            csvContent = csvContent.concat([
                [''],
                ['== æ”¯å‡ºè©³ç´° =='],
                ['çµŒè²» (æ—¥å ±)', autoExpenses],
                ['å®¶è³ƒ', rent],
                ['é€šä¿¡è²» (Wi-Fi)', wifi],
                ['ä¿é™ºæ–™', insurance],
                ['æ¥­å‹™å§”è¨—è²»', outsourcing],
                ['ãƒªãƒ¼ã‚¹ (ç¬¬ä¸€èˆˆå•† ç­‰)', lease],
                ['ãŠã—ã¼ã‚Š', towels],
                ['é›»æ°—', electricity],
                ['æ°´é“', water],
                ['ã‚¬ã‚¹', gas]
            ]);

            // å‹•çš„æ”¯å‡ºé …ç›®ã‚’è¿½åŠ 
            const dynamicExpenseItems = dynamicExpenses.filter(item => item.type === 'expense');
            dynamicExpenseItems.forEach(item => {
                csvContent.push([item.name + ' (è¿½åŠ æ”¯å‡º)', item.amount]);
            });

            csvContent = csvContent.concat([
                [''],
                ['== è¨ˆç®—çµæœ =='],
                ['ç·åå…¥', totalRevenue],
                ['ç·æ”¯å‡º', totalExpenses],
                ['ç´”åˆ©ç›Š', netProfit],
                [''],
                ['è¨ˆç®—æ—¥æ™‚', new Date().toLocaleString('ja-JP')]
            ]);

            const csvString = csvContent.map(row => row.join(',')).join('\n');

            const blob = new Blob(['\uFEFF' + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç´”åˆ©ç›Šè¨ˆç®—è©³ç´°_${fromDate}_${toDate}.csv`;
            link.click();

            showToast('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢æ©Ÿèƒ½
        function clearTestData() {
            localStorage.removeItem('salesData');
            localStorage.removeItem('editHistory');
            localStorage.removeItem('staffList');
            localStorage.removeItem('stores');
            localStorage.removeItem('storeData');
            localStorage.removeItem('budgetData');
            
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’åˆæœŸåŒ–
            salesData = [];
            editHistory = [];
            staffList = [];
            stores = {};
            storeData = {};
            budgetData = {};
            
            updateAllViews();
            showToast('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadData() {
            const savedSalesData = localStorage.getItem('salesData');
            const savedEditHistory = localStorage.getItem('editHistory');

            if (savedSalesData) {
                salesData = JSON.parse(savedSalesData);
            }

            if (savedEditHistory) {
                editHistory = JSON.parse(savedEditHistory);
            }
        }

        // ç·¨é›†è€…æƒ…å ±ã‚’å–å¾—
        function getEditorInfo(itemId) {
            const latestEdit = editHistory
                .filter(edit => edit.originalId === itemId)
                .sort((a, b) => new Date(b.editedAt) - new Date(a.editedAt))[0];
            
            if (latestEdit) {
                return {
                    editor: latestEdit.editor,
                    editDate: new Date(latestEdit.editedAt).toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'numeric',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                };
            }
            
            return { editor: null, editDate: null };
        }

        // æœ¬éƒ¨ç®¡ç†ç”»é¢ã®æ›´æ–°
        function updateHeadquartersView() {
            // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
            updateHQStatistics();
            
            // åº—èˆ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ›´æ–°
            updateStorePerformance();
            
            // æœˆåˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆã®æ›´æ–°
            updateMonthlyTrendChart();
            
            // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã®æ›´æ–°
            updateHQDetailTable();
            
            // åº—èˆ—ç®¡ç†ãƒªã‚¹ãƒˆæ›´æ–°
            updateStoreManagementList();
        }

        // æœ¬éƒ¨ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ›´æ–°
        function updateHQDashboard() {
            updateHQStatistics();
            updateStorePerformance();
            updateMonthlyTrendChart();
            updateHQDetailTable();
        }

        // æœ¬éƒ¨ç®¡ç†èªè¨¼åˆæœŸåŒ–
        function initializeHQAuth() {
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('cancelPasswordBtn').addEventListener('click', hidePasswordModal);
            document.getElementById('submitPasswordBtn').addEventListener('click', verifyPassword);
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
        }

        // åº—èˆ—ç®¡ç†åˆæœŸåŒ–
        function initializeStoreManagement() {
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('addStoreBtn').addEventListener('click', () => openStoreEditModal());
            document.getElementById('cancelStoreEditBtn').addEventListener('click', closeStoreEditModal);
            document.getElementById('storeEditForm').addEventListener('submit', saveStoreEdit);
            document.getElementById('saveBudgetBtn').addEventListener('click', saveBudget);
            
            // ã‚¹ãƒˆã‚¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadStoreData();
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('passwordModal').classList.add('flex');
            document.getElementById('adminPassword').focus();
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hidePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('passwordModal').classList.remove('flex');
            document.getElementById('adminPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é¨“è¨¼
        function verifyPassword() {
            const password = document.getElementById('adminPassword').value;
            const errorElement = document.getElementById('passwordError');
            
            if (password === 'admin') {
                isHQAuthenticated = true;
                hidePasswordModal();
                
                // ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                document.querySelector('[data-tab="headquarters"]').classList.add('active');
                document.getElementById('headquarters').classList.add('active');
                
                // ãƒ­ãƒƒã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤
                document.querySelector('[data-tab="headquarters"]').classList.remove('locked-tab');
                
                updateHeadquartersView();
                // çµ±è¨ˆæƒ…å ±ã‚’æ˜ç¤ºçš„ã«åˆæœŸåŒ–
                setTimeout(() => {
                    updateHQStatistics();
                }, 100);
                showToast('æœ¬éƒ¨ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã—ãŸ', 'success');
            } else {
                errorElement.classList.remove('hidden');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        // ã‚¹ãƒˆã‚¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadStoreData() {
            const savedStoreData = localStorage.getItem('storeData');
            const savedBudgetData = localStorage.getItem('budgetData');
            
            if (savedStoreData) {
                storeData = JSON.parse(savedStoreData);
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒˆã‚¢ãƒ‡ãƒ¼ã‚¿
                storeData = {
                    'store_001': 'æœ¬åº—',
                    'store_002': 'æ”¯åº—A',
                    'store_003': 'æ”¯åº—B',
                    'store_004': 'æ”¯åº—C'
                };
                localStorage.setItem('storeData', JSON.stringify(storeData));
            }
            
            // storesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’storeDataã¨åŒæœŸ
            stores = { ...storeData };
            
            if (savedBudgetData) {
                budgetData = JSON.parse(savedBudgetData);
            }
            
            updateStoreSelects();
        }

        // ã‚¹ãƒˆã‚¢ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ›´æ–°
        function updateStoreSelects() {
            const selects = [
                'store_id', 'analysisStore', 'historyStore', 'hqStoreSelect', 'budgetStoreSelect'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    const options = select.innerHTML.split('</option>')[0] + '</option>';
                    
                    select.innerHTML = options;
                    
                    Object.keys(storeData).forEach(storeId => {
                        const option = document.createElement('option');
                        option.value = storeId;
                        option.textContent = storeData[storeId];
                        select.appendChild(option);
                    });
                    
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // åº—èˆ—ãƒªã‚¹ãƒˆæ›´æ–°
        function updateStoreManagementList() {
            const list = document.getElementById('storeManagementList');
            
            list.innerHTML = Object.keys(storeData).map(storeId => {
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <div>
                                <div class="font-medium text-gray-800">${storeData[storeId]}</div>
                                <div class="text-sm text-gray-500">${storeId}</div>
                            </div>
                        </div>
                        <button onclick="openStoreEditModal('${storeId}')" class="text-blue-600 hover:text-blue-800 font-medium text-sm">
                            ç·¨é›†
                        </button>
                    </div>
                `;
            }).join('');
        }

        // åº—èˆ—ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openStoreEditModal(storeId = null) {
            const modal = document.getElementById('storeEditModal');
            const title = document.getElementById('storeEditModalTitle');
            const editStoreId = document.getElementById('editStoreId');
            const editStoreIdInput = document.getElementById('editStoreIdInput');
            const editStoreName = document.getElementById('editStoreName');
            
            if (storeId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                title.textContent = 'åº—èˆ—ç·¨é›†';
                editStoreId.value = storeId;
                editStoreIdInput.value = storeId;
                editStoreIdInput.readOnly = true;
                editStoreName.value = storeData[storeId];
            } else {
                // æ–°è¦ãƒ¢ãƒ¼ãƒ‰
                title.textContent = 'æ–°è¦åº—èˆ—è¿½åŠ ';
                editStoreId.value = '';
                editStoreIdInput.value = '';
                editStoreIdInput.readOnly = false;
                editStoreName.value = '';
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // åº—èˆ—ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeStoreEditModal() {
            document.getElementById('storeEditModal').classList.add('hidden');
            document.getElementById('storeEditModal').classList.remove('flex');
        }

        // åº—èˆ—ç·¨é›†ä¿å­˜
        function saveStoreEdit(e) {
            e.preventDefault();
            
            const originalStoreId = document.getElementById('editStoreId').value;
            const newStoreId = document.getElementById('editStoreIdInput').value.trim();
            const storeName = document.getElementById('editStoreName').value.trim();
            
            if (!newStoreId || !storeName) {
                showToast('åº—èˆ—IDã¨åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (originalStoreId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                storeData[originalStoreId] = storeName;
                stores[originalStoreId] = storeName;
                showToast('åº—èˆ—æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } else {
                // æ–°è¦ãƒ¢ãƒ¼ãƒ‰
                if (storeData[newStoreId]) {
                    showToast('ã“ã®åº—èˆ—IDã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™', 'error');
                    return;
                }
                storeData[newStoreId] = storeName;
                stores[newStoreId] = storeName;
                showToast('æ–°ã—ã„åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
            }
            
            localStorage.setItem('storeData', JSON.stringify(storeData));
            updateStoreSelects();
            updateStoreManagementList();
            updateAllViews();
            closeStoreEditModal();
        }

        // äºˆç®—ä¿å­˜
        function saveBudget() {
            const storeId = document.getElementById('budgetStoreSelect').value;
            const amount = parseInt(document.getElementById('budgetAmount').value);
            const month = document.getElementById('budgetMonth').value;
            
            if (!storeId || !amount || !month) {
                showToast('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const budgetKey = `${storeId}_${month}`;
            budgetData[budgetKey] = {
                storeId: storeId,
                amount: amount,
                month: month,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('budgetData', JSON.stringify(budgetData));
            
            document.getElementById('budgetStoreSelect').value = '';
            document.getElementById('budgetAmount').value = '';
            document.getElementById('budgetMonth').value = '';
            
            showToast('äºˆç®—ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        // æœ¬éƒ¨çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
        function updateHQStatistics() {
            const storeId = document.getElementById('hqStoreSelect').value;
            const fromDate = document.getElementById('hqFromDate').value;
            const toDate = document.getElementById('hqToDate').value;

            console.log('updateHQStatistics called:', { storeId, fromDate, toDate });

            let filteredData = salesData;

            if (storeId) {
                filteredData = filteredData.filter(item => item.store_id === storeId);
            }

            if (fromDate) {
                filteredData = filteredData.filter(item => item.date >= fromDate);
            }

            if (toDate) {
                filteredData = filteredData.filter(item => item.date <= toDate);
            }

            console.log('Filtered data:', filteredData);

            const totalSales = filteredData.reduce((sum, item) => sum + item.total_sales, 0);
            const avgDailySales = filteredData.length > 0 ? totalSales / filteredData.length : 0;
            
            // ç¨¼åƒåº—èˆ—æ•°ã®ç®—å‡ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«ã‚ˆã‚Šç•°ãªã‚‹ï¼‰
            let activeStores;
            if (storeId) {
                // ç‰¹å®šã®åº—èˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
                activeStores = filteredData.length > 0 ? 1 : 0;
            } else {
                // å…¨åº—èˆ—ã®å ´åˆ
                activeStores = new Set(filteredData.map(item => item.store_id)).size;
            }

            console.log('Statistics:', { totalSales, avgDailySales, activeStores });

            // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã«æ›´æ–°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const statsCards = ['totalSalesAmount', 'avgDailySales', 'activeStoreCount'];
            statsCards.forEach(id => {
                const element = document.getElementById(id);
                element.style.transform = 'scale(1.05)';
                element.style.transition = 'transform 0.2s ease';
            });

            document.getElementById('totalSalesAmount').textContent = `Â¥${formatNumber(totalSales)}`;
            document.getElementById('avgDailySales').textContent = `Â¥${formatNumber(Math.round(avgDailySales))}`;
            document.getElementById('activeStoreCount').textContent = activeStores;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å…ƒã«æˆ»ã™
            setTimeout(() => {
                statsCards.forEach(id => {
                    const element = document.getElementById(id);
                    element.style.transform = 'scale(1)';
                });
            }, 200);
        }

        // åº—èˆ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ›´æ–°
        function updateStorePerformance() {
            const storeId = document.getElementById('hqStoreSelect').value;
            const fromDate = document.getElementById('hqFromDate').value;
            const toDate = document.getElementById('hqToDate').value;

            let filteredData = salesData;

            if (fromDate) {
                filteredData = filteredData.filter(item => item.date >= fromDate);
            }

            if (toDate) {
                filteredData = filteredData.filter(item => item.date <= toDate);
            }

            const performanceData = {};
            filteredData.forEach(item => {
                if (!performanceData[item.store_id]) {
                    performanceData[item.store_id] = {
                        totalSales: 0,
                        count: 0
                    };
                }
                performanceData[item.store_id].totalSales += item.total_sales;
                performanceData[item.store_id].count++;
            });

            const performanceList = document.getElementById('storePerformanceList');
            
            if (Object.keys(performanceData).length === 0) {
                performanceList.innerHTML = '<div class="text-center text-gray-500 py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            performanceList.innerHTML = Object.entries(performanceData).map(([storeId, data]) => {
                const storeName = stores[storeId] || storeData[storeId] || storeId;
                const avgSales = data.count > 0 ? data.totalSales / data.count : 0;
                const growth = Math.floor(Math.random() * 20) - 10; // ã‚µãƒ³ãƒ—ãƒ«æˆé•·ç‡
                const status = growth >= 0 ? 'good' : 'warning';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 rounded-full ${status === 'good' ? 'bg-green-500' : 'bg-orange-500'}"></div>
                            <div>
                                <div class="font-medium text-gray-800">${storeName}</div>
                                <div class="text-sm text-gray-500">${data.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-gray-800">Â¥${formatNumber(data.totalSales)}</div>
                            <div class="text-sm ${growth >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${growth >= 0 ? '+' : ''}${growth}%
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æœˆåˆ¥ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆã®æ›´æ–°ï¼ˆå‰æœˆå¯¾æ¯”ï¼‰
        function updateMonthlyTrendChart() {
            const ctx = document.getElementById('monthlyTrendChart');
            if (!ctx) return;

            if (monthlyTrendChart) {
                monthlyTrendChart.destroy();
            }

            const storeId = document.getElementById('hqStoreSelect').value;
            let filteredData = salesData;

            if (storeId) {
                filteredData = filteredData.filter(item => item.store_id === storeId);
            }

            // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
            const monthlyData = {};
            filteredData.forEach(item => {
                const monthKey = item.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { sales: 0, count: 0 };
                }
                monthlyData[monthKey].sales += item.total_sales;
                monthlyData[monthKey].count++;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const currentMonthData = sortedMonths.map(month => monthlyData[month].sales);
            
            // å‰æœˆå¯¾æ¯”ã®è¨ˆç®—
            const previousMonthData = [0, ...currentMonthData.slice(0, -1)];
            const comparisonData = currentMonthData.map((current, index) => {
                const previous = previousMonthData[index];
                return previous > 0 ? ((current - previous) / previous) * 100 : 0;
            });

            monthlyTrendChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'å£²ä¸Š',
                        data: currentMonthData,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'å‰æœˆå¯¾æ¯”(%)',
                        data: comparisonData,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + formatNumber(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
        function updateHQDetailTable() {
            const storeId = document.getElementById('hqStoreSelect').value;
            const fromDate = document.getElementById('hqFromDate').value;
            const toDate = document.getElementById('hqToDate').value;

            let filteredData = salesData;

            if (storeId) {
                filteredData = filteredData.filter(item => item.store_id === storeId);
            }

            if (fromDate) {
                filteredData = filteredData.filter(item => item.date >= fromDate);
            }

            if (toDate) {
                filteredData = filteredData.filter(item => item.date <= toDate);
            }

            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));

            const tbody = document.getElementById('hqDetailTableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            tbody.innerHTML = filteredData.map(item => {
                const profit = item.total_sales - item.expense;
                const achievement = Math.floor(Math.random() * 50) + 75; // ã‚µãƒ³ãƒ—ãƒ«é”æˆç‡
                const achievementColor = achievement >= 100 ? 'text-green-600' : 'text-red-600';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="px-4 py-3">${item.date}</td>
                        <td class="px-4 py-3">${stores[item.store_id] || storeData[item.store_id] || item.store_id}</td>
                        <td class="px-4 py-3">Â¥${formatNumber(item.total_sales)}</td>
                        <td class="px-4 py-3">Â¥${formatNumber(item.expense)}</td>
                        <td class="px-4 py-3 font-semibold">Â¥${formatNumber(profit)}</td>
                        <td class="px-4 py-3 font-semibold ${achievementColor}">${achievement}%</td>
                    </tr>
                `;
            }).join('');
        }

        // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatNumber(num) {
            return num.toLocaleString('ja-JP');
        }

        // æ›´æ–°ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showUpdateLoading() {
            document.getElementById('updateBtnText').classList.add('hidden');
            document.getElementById('updateBtnLoading').classList.remove('hidden');
            document.getElementById('hqUpdateBtn').disabled = true;
        }

        // æ›´æ–°ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        function hideUpdateLoading() {
            document.getElementById('updateBtnText').classList.remove('hidden');
            document.getElementById('updateBtnLoading').classList.add('hidden');
            document.getElementById('hqUpdateBtn').disabled = false;
        }

        // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«åˆæœŸåŒ–
        function initializeConfirmationModal() {
            document.getElementById('cancelConfirmBtn').addEventListener('click', hideConfirmationModal);
            document.getElementById('finalSubmitBtn').addEventListener('click', finalSubmit);
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
            const checkboxes = ['checkDate', 'checkStore', 'checkSales', 'checkExpense', 'checkTotal'];
            checkboxes.forEach(id => {
                document.getElementById(id).addEventListener('change', updateSubmitButton);
            });
        }

        // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showConfirmationModal(formData) {
            // ç™»éŒ²å†…å®¹ã‚’è¡¨ç¤º
            document.getElementById('confirmDate').textContent = formData.date;
            document.getElementById('confirmStore').textContent = stores[formData.store_id] || storeData[formData.store_id] || formData.store_id;
            document.getElementById('confirmStaff').textContent = formData.staff_name;
            document.getElementById('confirmCash').textContent = `Â¥${formatNumber(formData.cash_sales)}`;
            document.getElementById('confirmCard').textContent = `Â¥${formatNumber(formData.card_sales)}`;
            document.getElementById('confirmExpense').textContent = `Â¥${formatNumber(formData.expense)}`;
            document.getElementById('confirmLiquor').textContent = `Â¥${formatNumber(formData.liquor_delivery)}`;
            document.getElementById('confirmTotal').textContent = `Â¥${formatNumber(formData.total_sales)}`;
            document.getElementById('confirmBalance').textContent = `Â¥${formatNumber(formData.envelope_balance)}`;
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const checkboxes = ['checkDate', 'checkStore', 'checkSales', 'checkExpense', 'checkTotal'];
            checkboxes.forEach(id => {
                document.getElementById(id).checked = false;
            });
            
            // ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            updateSubmitButton();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜
            window.tempFormData = formData;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            document.getElementById('confirmationModal').classList.remove('hidden');
            document.getElementById('confirmationModal').classList.add('flex');
        }

        // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hideConfirmationModal() {
            document.getElementById('confirmationModal').classList.add('hidden');
            document.getElementById('confirmationModal').classList.remove('flex');
            window.tempFormData = null;
        }

        // ç™»éŒ²ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
        function updateSubmitButton() {
            const checkboxes = ['checkDate', 'checkStore', 'checkSales', 'checkExpense', 'checkTotal'];
            const allChecked = checkboxes.every(id => document.getElementById(id).checked);
            
            const submitBtn = document.getElementById('finalSubmitBtn');
            if (allChecked) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // æœ€çµ‚ç™»éŒ²å®Ÿè¡Œ
        function finalSubmit() {
            if (!window.tempFormData) return;
            
            salesData.push(window.tempFormData);
            saveData();
            clearForm();
            updateAllViews();
            hideConfirmationModal();
            showToast('å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast px-6 py-4 rounded-lg shadow-lg text-white font-medium ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
    </script>
</body>
</html>